#!/bin/sh

# after
after () {
	local_clear_cache
}

local_clear_cache() {
	echo "Clearing cache ..."
}

USAGE="$USAGE
"


# try to recognize Drupal 7 - there might be better ways
ISDRUPAL7=0; 
if [ -d "http/includes" ]; then 
	ISDRUPAL7=1; 
	echo "Drupal 7 found"
	EXCLUDEFROM="$EXCLUDEFROM --exclude-from $SCRIPTPATH/deploy-exclude-drupal7.txt"


	if [ ! -z $LOCALDBPASSWORD ]; then
		php_code=$(cat <<-'EOF' 
			error_reporting(E_ERROR | E_PARSE);
			$drupal_version = '';
		
			$conffile = getcwd() . "/http/sites/default/settings.php";
			if (is_file($conffile)) {
				include($conffile); 
				$db = $databases['default']['default'];
				$db_host = $db['host'];
				$db_username = $db['username'];
				$db_password = $db['password'];
				$db_db = $db['database'];
			}	
			echo implode(";", array(
				$drupal_version,
				$db_host,
				$db_username,
				$db_password,
				$db_db
			));
	
	EOF
	)

	php_cwd=`/usr/bin/php -r "$php_code"`
	
	CONFIG=$php_cwd
	LOCALVERSION=`echo $CONFIG | awk '{split($0,a,";"); print a[1]}'`
	LOCALDBHOST=`echo $CONFIG | awk '{split($0,a,";"); print a[2]}'`
	LOCALDBUSER=`echo $CONFIG | awk '{split($0,a,";"); print a[3]}'`
	LOCALDBPASSWORD=`echo $CONFIG | awk '{split($0,a,";"); print a[4]}'`
	LOCALDB=`echo $CONFIG | awk '{split($0,a,";"); print a[5]}'`

#php_cwd=`ssh $REMOTEUSER@$REMOTEHOST <<'EOF'`
#/usr/bin/php -r "print_r($_SERVER)"
#EOF

#		echo $php_cwd
	
	
fi	
fi

if [ $handled ]
then 
	exit; 
fi	
	
case "$1" in 
	"cc" )
		local_clear_cache
		;;

	"users-disable-except" )
		if [ ISDRUPAL7 ]; then				
			username=$2
			if [ ! -n "$username" ]; then echo "Usage : deploy users-disable-except <except-username>"; exit 1;
			fi
			
			echo "update users set status=0 where name != '$username';" > deploy-temp.sql
			
		fi
		if [ -f deploy-temp.sql ]; then
			mysql -h $LOCALDBHOST -u $LOCALDBUSER -p$LOCALDBPASSWORD $LOCALDB < deploy-temp.sql
			echo "All users except '$username' disabled."
			handled=1;
	
		fi
	;;
	
	#
	# Show all permissions that role 1 has, but role 2 has not.
	#
	"diff-permissions" )
		rid1="$2"
		rid2="$3"
  	if [ -z "$rid2" ]; then echo "Usage : deploy diff-permissions <rid1> <rid2>"; exit 1;
		fi
			  
	  sqlq "select rid, name from role where rid in ($rid1, $rid2)"
	  sqlq "SELECT p1.rid, p1.permission 
	  FROM role_permission as p1 left join role_permission as p2 on p1.permission=p2.permission and p1.rid=$rid1 and p2.rid=$rid2 
	  where p1.rid =$rid1 and p2.rid is null"
	;;

  "dis" )
    sqlq "update system set status=0 where name='$2'";
  ;;
  
  "watchdog-tail" )
    while true
    do
      clear      
      q=`sqlq "select type, message, variables, severity, link, location, timestamp from watchdog order by timestamp desc limit 15" `
			php_code=$(cat <<-'EOF' 
		$e=array_reverse(explode("\n", $argv[1]));
		
		array_pop($e);
		foreach ($e as $i) {
		  list($type, $message, $variables, $severity, $link, $location, $timestamp) = explode("\t", $i);	
		  $variables = unserialize($variables);
		  #print_r($variables);
		  if (is_array($variables))
		  	print implode("\n    ", array(
		  	  strftime('%d.%m.%Y %H.%M', $timestamp) . ' : ' . $type,
		  		substr(str_replace(array_keys($variables), $variables, $message), 0, 100),
		  	  $location,
		  	)) . "\n";
		}
		EOF
		)
	php_cwd=`/usr/bin/php -r "$php_code" "$q"`

      echo "$php_cwd"
      sleep 1
    done
    
  ;;
esac


