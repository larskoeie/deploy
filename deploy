#!/bin/bash

# Absolute path to this script. /home/user/bin/foo.sh
SCRIPT=$(readlink -f $0)
# Absolute path this script is in. /home/user/bin
SCRIPTPATH=`dirname $SCRIPT`
REMOTEHTTPFOLDER="http/"

LOCALROOT=`pwd`

if [ ! -n "$1" ]; then echo "usage: deploy <command> path
commands :
  diff
  	Show files and folders in specified path on local that are not on remote or have different size or timestamp
  up
  	Upload the specified path from local to remote using rsync
  dbup
  	
  down
  	Download the specified path from remote to local using rsync
  dbdiff
  dbdown
	dumplocaldb
		Dump the local db to file
	dumpremotedb
		Dump the remote db to file
		  
";
	exit 1;
fi

# check if in site root (one above http/)
if [ ! -d "http" ]; then echo "Not site root."; 
	exit 1;
fi

# load site configuration
if [ ! -f ".deploy.cnf" ]; then echo "Missing .deploy.cnf."; exit;
fi
source .deploy.cnf

echo "Remote host : $REMOTEHOST";
echo "Remote root : $REMOTEROOT";

LOCALSITENAME=`basename $LOCALROOT`
REMOTESITENAME=`basename $REMOTEROOT`
TIME=`date +"%y%m%d"`
DIFFCOLORSED='s/^-/\x1b[41m-/;s/^+/\x1b[44m+/;s/$/\x1b[0m/'

if [ ! $REMOTEHOST ]; then echo "Invalid .deploy.cnf"; exit;
fi

EXCLUDEFROM=$SCRIPTPATH/deploy-exclude.txt

if [ -d "http/typo3" ]; then echo "Looks like TYPO3 site"; 
	ISTYPO3=TRUE; 
	EXCLUDEFROM=$SCRIPTPATH/deploy-exclude-typo3.txt
fi

if [ -d "http/includes" ]; then echo "Looks like Drupal site";
	ISDRUPAL=TRUE; 
fi

# substitute "http/" with the name of the http-folder on remote
REMOTEPATH="$REMOTEHTTPFOLDER${2:5}"
echo $REMOTEPATH

#if [ ! $ISTYPO3 ] && [ ! $ISDRUPAL ]; then exit 1;
#fi

case "$1" in 
		
	"diff" )
		if [ ! -n "$2" ]; then echo "missing path"; exit 1; 
		fi

		echo "Diffing $2 ...";

		if [ -f $2 ] 
		then
			diff -w -u --include=*.* <(ssh $REMOTEUSER@$REMOTEHOST "cat $REMOTEROOT$REMOTEPATH") $2 | sed 's/^-/\x1b[41m-/;s/^+/\x1b[44m+/;s/$/\x1b[0m/'
		fi
		if [ -d $2 ] 
		then
			rsync -avnc --exclude-from $SCRIPTPATH/deploy-exclude.txt --exclude-from $EXCLUDEFROM $2 $REMOTEUSER@$REMOTEHOST:$REMOTEROOT$REMOTEPATH
		fi
	
		;;
		
	"diffdb" )
		LOCAL="/home/lars/$LOCALSITENAME-local.sql"
		REMOTE="/home/lars/$LOCALSITENAME-remote.sql"
		
		if [ ! -f $LOCAL ] 
			then echo "no local dump - use dumplocaldb"; exit;
		fi
		if [ ! -f $REMOTE ] 
			then echo "no remote dump - use dumpremotedb"; exit;
		fi
		
		diff $LOCAL $REMOTE | sed $DIFFCOLORSED
		;;
		
	"down" )
		if [ ! -n "$2" ]; then echo "missing path"; exit 1; 
		fi

		echo "Downloading $2 ...";
		rsync -av --exclude-from $SCRIPTPATH/deploy-exclude.txt --exclude-from $EXCLUDEFROM $REMOTEUSER@$REMOTEHOST:$REMOTEROOT$REMOTEPATH $2 
		;;

	"downdb" )
		DUMPPATH="$LOCALSITENAME-remote.sql"
		ssh $REMOTEUSER@$REMOTEHOST "mysqldump -h $REMOTEDBHOST -u $REMOTEDBUSER -p $REMOTEDB > temp.sql"
		scp $REMOTEUSER@$REMOTEHOST:~/temp.sql $DUMPPATH 		
		;;
		
	"dumplocaldb" )
		DUMPPATH="$LOCALSITENAME-local.sql"
		echo "Dumping to $DUMPPATH ..."
		mysqldump -h $LOCALDBHOST -u $LOCALDBUSER -p $LOCALDB > ~/$DUMPPATH
		;;
		
	"dumpremotedb" )
		DUMPPATH="$LOCALSITENAME-remote.sql"
		ssh $REMOTEUSER@$REMOTEHOST "mysqldump -h $REMOTEDBHOST -u $REMOTEDBUSER -p $REMOTEDB > ~/temp.sql"
		scp $REMOTEUSER@$REMOTEHOST:~/temp.sql ~/$DUMPPATH 		
		;;	
		
	"up" )
		if [ ! -n "$2" ]; then echo "missing path"; exit 1; 
		fi

		echo "Uploading $2 ...";
		rsync -a --exclude-from $SCRIPTPATH/deploy-exclude.txt --exclude-from $EXCLUDEFROM $2 $REMOTEUSER@$REMOTEHOST:$REMOTEROOT$REMOTEPATH		
		;;

esac

